From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Valerio Valerio <valerio.valerio@jollamobile.com>
Date: Mon, 2 Feb 2015 17:03:21 +0200
Subject: [PATCH] Listen to sync schedule changes from buteo sync framework.

This commit introduces d-bus listeners inside IMAP4 service to
react to changes in the account schedule related to always-on mode
and activate/deactivate IMAP IDLE.
---
 src/plugins/messageservices/imap/imap.pro     |  1 +
 .../imap/imapconfiguration.cpp                |  4 +--
 .../messageservices/imap/imapservice.cpp      | 28 +++++++++++++++++++
 .../messageservices/imap/imapservice.h        |  2 ++
 src/tools/systemd/messageserver5.service      |  2 +-
 5 files changed, 34 insertions(+), 3 deletions(-)

diff --git a/src/plugins/messageservices/imap/imap.pro b/src/plugins/messageservices/imap/imap.pro
index aa12edab..54addffe 100644
--- a/src/plugins/messageservices/imap/imap.pro
+++ b/src/plugins/messageservices/imap/imap.pro
@@ -5,6 +5,7 @@ PLUGIN_CLASS_NAME = QmfImapPlugin
 load(qt_plugin)
 
 QT = core network qmfclient qmfclient-private qmfmessageserver qmfmessageserver-private
+QT += dbus
 
 contains(DEFINES, USE_KEEPALIVE) {
     PKGCONFIG += keepalive
diff --git a/src/plugins/messageservices/imap/imapconfiguration.cpp b/src/plugins/messageservices/imap/imapconfiguration.cpp
index 4192d1f0..b484b737 100644
--- a/src/plugins/messageservices/imap/imapconfiguration.cpp
+++ b/src/plugins/messageservices/imap/imapconfiguration.cpp
@@ -103,7 +103,7 @@ QString ImapConfiguration::preferredTextSubtype() const
 
 bool ImapConfiguration::pushEnabled() const
 {
-    return (value("pushEnabled", "0").toInt() != 0);
+    return (value("internalPushEnabledFromButeo", "0").toInt() != 0);
 }
 
 QString ImapConfiguration::baseFolder() const
@@ -267,7 +267,7 @@ void ImapConfigurationEditor::setPreferredTextSubtype(const QString &str)
 
 void ImapConfigurationEditor::setPushEnabled(bool b)
 {
-    setValue("pushEnabled", QString::number(b ? 1 : 0));
+    setValue("internalPushEnabledFromButeo", QString::number(b ? 1 : 0));
 }
 
 void ImapConfigurationEditor::setBaseFolder(const QString &s)
diff --git a/src/plugins/messageservices/imap/imapservice.cpp b/src/plugins/messageservices/imap/imapservice.cpp
index b998e06b..7d341f29 100644
--- a/src/plugins/messageservices/imap/imapservice.cpp
+++ b/src/plugins/messageservices/imap/imapservice.cpp
@@ -44,6 +44,10 @@
 #include <QCoreApplication>
 #include <typeinfo>
 
+#include <QDBusConnection>
+#include <QDBusInterface>
+#include <QDBusPendingCall>
+
 namespace {
 
 const QString serviceKey("imap4");
@@ -1416,6 +1420,13 @@ ImapService::ImapService(const QMailAccountId &accountId)
     connect(_restartPushEmailTimer, &QTimer::timeout, this, &ImapService::restartPushEmail);
     connect(QMailStore::instance(), &QMailStore::accountsUpdated,
             this, &ImapService::accountsUpdated);
+
+    QDBusConnection::sessionBus().connect("com.meego.msyncd", "/synchronizer",
+                                          "com.meego.msyncd", "syncedExternallyStatus",
+                                          this, SLOT(onSyncedExternallyChanged(uint,QString,bool)));
+    QDBusInterface iface("com.meego.msyncd", "/synchronizer", "com.meego.msyncd");
+    iface.asyncCall(QLatin1String("isSyncedExternally"),
+                    uint(_accountId.toULongLong()), "syncemail");
 }
 
 void ImapService::enable()
@@ -1789,6 +1800,23 @@ void ImapService::setPersistentConnectionStatus(bool status)
     _idling = status;
 }
 
+void ImapService::onSyncedExternallyChanged(uint accountId, const QString &profileType, bool state)
+{
+    qCDebug(lcIMAP) << "Received new idleState for account: " << accountId << "state: " << state << "profile type: " << profileType;
+    if (accountId == _accountId.toULongLong()
+        && profileType == QLatin1String("syncemail")) {
+        QMailAccountConfiguration config(_accountId);
+        ImapConfiguration imapCfg(config);
+        if ((imapCfg.pushEnabled() && !state) ||
+            (!imapCfg.pushEnabled() && state)) {
+            ImapConfigurationEditor editCfg(&config);
+            editCfg.setPushEnabled(state);
+            if (!QMailStore::instance()->updateAccountConfiguration(&config)) {
+                qCWarning(lcMailStore) << "Unable to update account" << _accountId;
+            }
+        }
+    }
+}
 
 ImapServicePlugin::ImapServicePlugin()
     : QMailMessageServicePlugin()
diff --git a/src/plugins/messageservices/imap/imapservice.h b/src/plugins/messageservices/imap/imapservice.h
index 0e6973da..d9394d16 100644
--- a/src/plugins/messageservices/imap/imapservice.h
+++ b/src/plugins/messageservices/imap/imapservice.h
@@ -74,6 +74,8 @@ private slots:
     void openIdleSession();
     void closeIdleSession();
 
+    void onSyncedExternallyChanged(uint accountId, const QString &profileType, bool state);
+
     void onOnlineStateChanged(bool isOnline);
     void onSessionOpened();
     void onSessionStateChanged(IdleNetworkSession::State status);
diff --git a/src/tools/systemd/messageserver5.service b/src/tools/systemd/messageserver5.service
index a5aa05a9..9622d701 100644
--- a/src/tools/systemd/messageserver5.service
+++ b/src/tools/systemd/messageserver5.service
@@ -2,7 +2,7 @@
 Description=messageserver5
 Requires=messageserver5-accounts-check.service
 Requires=booster-qt5.service
-After=booster-qt5.service
+After=msyncd.service
 After=messageserver5-accounts-check.service
 
 [Service]
