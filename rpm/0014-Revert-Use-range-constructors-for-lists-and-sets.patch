From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Damien Caliste <dcaliste@free.fr>
Date: Wed, 19 May 2021 08:59:40 +0200
Subject: [PATCH] Revert "Use range constructors for lists and sets"

This reverts commit 260cb748a7556b1e6a70efa05522c01200dda823.
---
 src/libraries/qmfclient/qmailmessagekey.cpp   |  9 ++---
 .../qmfclient/qmailmessagelistmodel.cpp       |  4 +-
 src/libraries/qmfclient/qmailmessageset.cpp   | 15 +++----
 .../qmfclient/qmailmessagethreadedmodel.cpp   | 14 +++----
 src/libraries/qmfclient/qmailstore.cpp        | 15 +++----
 .../qmfclient/qmailstorenotifier_p.cpp        | 18 ++++-----
 .../messageservices/imap/imapservice.cpp      |  2 +-
 .../messageservices/imap/imapstrategy.cpp     | 24 +++++-------
 src/tools/messageserver/messageserver.cpp     |  2 +-
 src/tools/messageserver/servicehandler.cpp    | 39 +++++++------------
 src/tools/messageserver/servicehandler.h      |  1 -
 .../tst_qmaildisconnected.cpp                 |  2 +-
 .../tst_qmailserviceaction.cpp                |  2 +-
 .../tst_qmailstorekeys/tst_qmailstorekeys.cpp | 36 +++++++----------
 14 files changed, 73 insertions(+), 110 deletions(-)

diff --git a/src/libraries/qmfclient/qmailmessagekey.cpp b/src/libraries/qmfclient/qmailmessagekey.cpp
index fec58c1d..4bfdde46 100644
--- a/src/libraries/qmfclient/qmailmessagekey.cpp
+++ b/src/libraries/qmfclient/qmailmessagekey.cpp
@@ -376,8 +376,7 @@ QMailMessageKey QMailMessageKey::id(const QMailMessageIdList &ids, QMailDataComp
     if (ids.count() >= IdLookupThreshold) {
         // If there are a large number of IDs, they will be inserted into a temporary table
         // with a uniqueness constraint; ensure only unique values are supplied
-        const QSet<QMailMessageId> uniqueIds(ids.constBegin(), ids.constEnd());
-        return QMailMessageKey(uniqueIds.values(), Id, QMailKey::comparator(cmp));
+        return QMailMessageKey(ids.toSet().toList(), Id, QMailKey::comparator(cmp));
     }
 
     return QMailMessageKey(ids, Id, QMailKey::comparator(cmp));
@@ -655,8 +654,7 @@ QMailMessageKey QMailMessageKey::serverUid(const QStringList &uids, QMailDataCom
     if (uids.count() >= IdLookupThreshold) {
         // If there are a large number of UIDs, they will be inserted into a temporary table
         // with a uniqueness constraint; ensure only unique values are supplied
-        const QSet<QString> uniqueIds(uids.constBegin(), uids.constEnd());
-        return QMailMessageKey(uniqueIds.values(), ServerUid, QMailKey::comparator(cmp));
+        return QMailMessageKey(uids.toSet().toList(), ServerUid, QMailKey::comparator(cmp));
     }
 
     return QMailMessageKey(uids, ServerUid, QMailKey::comparator(cmp));
@@ -985,8 +983,7 @@ QMailMessageKey QMailMessageKey::copyServerUid(const QStringList &uids, QMailDat
     if (uids.count() >= IdLookupThreshold) {
         // If there are a large number of UIDs, they will be inserted into a temporary table
         // with a uniqueness constraint; ensure only unique values are supplied
-        const QSet<QString> uniqueIds(uids.constBegin(), uids.constEnd());
-        return QMailMessageKey(uniqueIds.values(), CopyServerUid, QMailKey::comparator(cmp));
+        return QMailMessageKey(uids.toSet().toList(), CopyServerUid, QMailKey::comparator(cmp));
     }
 
     return QMailMessageKey(uids, CopyServerUid, QMailKey::comparator(cmp));
diff --git a/src/libraries/qmfclient/qmailmessagelistmodel.cpp b/src/libraries/qmfclient/qmailmessagelistmodel.cpp
index 907eb793..f9ed017f 100644
--- a/src/libraries/qmfclient/qmailmessagelistmodel.cpp
+++ b/src/libraries/qmfclient/qmailmessagelistmodel.cpp
@@ -402,9 +402,7 @@ bool QMailMessageListModelPrivate::updateMessages(const QMailMessageIdList &ids)
     QList<int> updateIndices;
 
     // Find the updated positions for our messages
-    QSet<QMailMessageId> uniqueIds(_idList.constBegin(), _idList.constEnd());
-    uniqueIds.unite(QSet<QMailMessageId>(ids.constBegin(), ids.constEnd()));
-    QMailMessageKey idKey(QMailMessageKey::id(uniqueIds.values()));
+    QMailMessageKey idKey(QMailMessageKey::id((_idList.toSet() + ids.toSet()).toList()));
     QMailMessageIdList newIds(QMailStore::instance()->queryMessages(_key & idKey, _sortKey, _limit));
     QMap<QMailMessageId, int> newPositions;
 
diff --git a/src/libraries/qmfclient/qmailmessageset.cpp b/src/libraries/qmfclient/qmailmessageset.cpp
index e263f195..95678793 100644
--- a/src/libraries/qmfclient/qmailmessageset.cpp
+++ b/src/libraries/qmfclient/qmailmessageset.cpp
@@ -976,7 +976,7 @@ void QMailFilterMessageSet::messagesAdded(const QMailMessageIdList &ids)
         QMailMessageIdList matchingIds = QMailStore::instance()->queryMessages(key & idFilter);
         if (!matchingIds.isEmpty()) {
             // Our filtered message set has changed
-            d->_messageIds.unite(QSet<QMailMessageId>(matchingIds.constBegin(), matchingIds.constEnd()));
+            d->_messageIds.unite(QSet<QMailMessageId>::fromList(matchingIds));
             update(this);
         }
     }
@@ -989,7 +989,7 @@ void QMailFilterMessageSet::messagesRemoved(const QMailMessageIdList &ids)
 
     QSet<QMailMessageId>& _messageIds = d->_messageIds;
     if (!_messageIds.isEmpty()) {
-        QSet<QMailMessageId> removedIds = QSet<QMailMessageId>(ids.constBegin(), ids.constEnd());
+        QSet<QMailMessageId> removedIds = QSet<QMailMessageId>::fromList(ids);
 
         // See if any of these messages are in our set
         removedIds.intersect(_messageIds);
@@ -1008,12 +1008,11 @@ void QMailFilterMessageSet::messagesUpdated(const QMailMessageIdList &ids)
     QMailMessageKey key(messageKey());
     if (!key.isNonMatching()) {
         QSet<QMailMessageId>& _messageIds = d->_messageIds;
-        QSet<QMailMessageId> updatedIds = QSet<QMailMessageId>(ids.constBegin(), ids.constEnd());
+        QSet<QMailMessageId> updatedIds = QSet<QMailMessageId>::fromList(ids);
 
         // Find which of the updated messages should be in our set
         QMailMessageKey idFilter(QMailMessageKey::id(ids));
-        const QMailMessageIdList filteredIds = QMailStore::instance()->queryMessages(key & idFilter);
-        QSet<QMailMessageId> matchingIds = QSet<QMailMessageId>(filteredIds.constBegin(), filteredIds.constEnd());
+        QSet<QMailMessageId> matchingIds = QSet<QMailMessageId>::fromList(QMailStore::instance()->queryMessages(key & idFilter));
 
         QSet<QMailMessageId> presentIds = updatedIds;
         QSet<QMailMessageId> absentIds = updatedIds;
@@ -1062,8 +1061,7 @@ void QMailFilterMessageSet::resyncState()
     Q_D(QMailFilterMessageSet);
 
     if (d->_minimized) {
-        const QMailMessageIdList ids = QMailStore::instance()->queryMessages(messageKey());
-        d->_messageIds = QSet<QMailMessageId>(ids.constBegin(), ids.constEnd());
+        d->_messageIds = QSet<QMailMessageId>::fromList(QMailStore::instance()->queryMessages(messageKey()));
     } else {
         d->_messageIds.clear();
     }
@@ -1085,8 +1083,7 @@ void QMailFilterMessageSet::reset()
     if (d->_minimized) {
         disconnect(model(), SIGNAL(folderContentsModified(QMailFolderIdList)), this, SLOT(folderContentsModified(QMailFolderIdList)));
 
-        const QMailMessageIdList ids = QMailStore::instance()->queryMessages(messageKey());
-        d->_messageIds = QSet<QMailMessageId>(ids.constBegin(), ids.constEnd());
+        d->_messageIds = QSet<QMailMessageId>::fromList(QMailStore::instance()->queryMessages(messageKey()));
 
         connect(model(), SIGNAL(messagesAdded(QMailMessageIdList)), this, SLOT(messagesAdded(QMailMessageIdList)));
         connect(model(), SIGNAL(messagesRemoved(QMailMessageIdList)), this, SLOT(messagesRemoved(QMailMessageIdList)));
diff --git a/src/libraries/qmfclient/qmailmessagethreadedmodel.cpp b/src/libraries/qmfclient/qmailmessagethreadedmodel.cpp
index 9c57a120..9e7dbfb7 100644
--- a/src/libraries/qmfclient/qmailmessagethreadedmodel.cpp
+++ b/src/libraries/qmfclient/qmailmessagethreadedmodel.cpp
@@ -543,13 +543,12 @@ bool QMailMessageThreadedModelPrivate::processMessagesUpdated(const QMailMessage
 
 bool QMailMessageThreadedModelPrivate::updateMessages(const QMailMessageIdList &ids)
 {
-    QSet<QMailMessageId> existingIds(_currentIds.constBegin(), _currentIds.constEnd());
-    existingIds.unite(QSet<QMailMessageId>(ids.constBegin(), ids.constEnd()));
+    QSet<QMailMessageId> existingIds(_currentIds.toSet());
 
-    QMailMessageKey idKey(QMailMessageKey::id(existingIds.values()));
+    QMailMessageKey idKey(QMailMessageKey::id((existingIds + ids.toSet()).toList()));
     QMailMessageIdList newIds(QMailStore::instance()->queryMessages(_key & idKey, _sortKey, _limit));
 
-    QSet<QMailMessageId> currentIds(newIds.constBegin(), newIds.constEnd());
+    QSet<QMailMessageId> currentIds(newIds.toSet());
 
     // Find which of the messages we must add and remove
     QMailMessageIdList additionIds;
@@ -649,10 +648,7 @@ bool QMailMessageThreadedModelPrivate::updateMessages(const QMailMessageIdList &
     removeMessages(temporaryRemovalIds, &readditionIds);
 
     // Find the locations for the added and reinserted messages
-    QSet<QMailMessageId> uniqueIds(additionIds.constBegin(), additionIds.constEnd());
-    uniqueIds.unite(QSet<QMailMessageId>(temporaryRemovalIds.constBegin(), temporaryRemovalIds.constEnd()));
-    uniqueIds.unite(QSet<QMailMessageId>(readditionIds.constBegin(), readditionIds.constEnd()));
-    addMessages(uniqueIds.values());
+    addMessages((additionIds.toSet() + temporaryRemovalIds.toSet() + readditionIds.toSet()).toList());
 
     return true;
 }
@@ -724,7 +720,7 @@ bool QMailMessageThreadedModelPrivate::removeMessages(const QMailMessageIdList &
     }
 
     if (readditions) {
-        *readditions = childIds.values();
+        *readditions = childIds.toList();
     }
 
     return true;
diff --git a/src/libraries/qmfclient/qmailstore.cpp b/src/libraries/qmfclient/qmailstore.cpp
index f35896b1..7ae0104e 100644
--- a/src/libraries/qmfclient/qmailstore.cpp
+++ b/src/libraries/qmfclient/qmailstore.cpp
@@ -1235,8 +1235,7 @@ void QMailStore::emitAccountNotification(ChangeType type, const QMailAccountIdLi
     Q_ASSERT(!ids.contains(QMailAccountId()));
     if (!ids.isEmpty()) {
         // Ensure there are no duplicates in the list
-        const QSet<QMailAccountId> uids(ids.constBegin(), ids.constEnd());
-        QMailAccountIdList idList(uids.constBegin(), uids.constEnd());
+        QMailAccountIdList idList(ids.toSet().toList());
 
         d->notifyAccountsChange(type, idList);
 
@@ -1266,8 +1265,7 @@ void QMailStore::emitFolderNotification(ChangeType type, const QMailFolderIdList
     Q_ASSERT(!ids.contains(QMailFolderId()));
     if (!ids.isEmpty()) {
         // Ensure there are no duplicates in the list
-        const QSet<QMailFolderId> uids(ids.constBegin(), ids.constEnd());
-        QMailFolderIdList idList(uids.constBegin(), uids.constEnd());
+        QMailFolderIdList idList(ids.toSet().toList());
 
         d->notifyFoldersChange(type, idList);
 
@@ -1297,8 +1295,7 @@ void QMailStore::emitThreadNotification(ChangeType type, const QMailThreadIdList
     Q_ASSERT(!ids.contains(QMailThreadId()));
     if (!ids.isEmpty()) {
         // Ensure there are no duplicates in the list
-        const QSet<QMailThreadId> uids(ids.constBegin(), ids.constEnd());
-        QMailThreadIdList idList(uids.constBegin(), uids.constEnd());
+        QMailThreadIdList idList(ids.toSet().toList());
 
         d->notifyThreadsChange(type, idList);
 
@@ -1328,8 +1325,7 @@ void QMailStore::emitMessageNotification(ChangeType type, const QMailMessageIdLi
     Q_ASSERT(!ids.contains(QMailMessageId()));
     if (!ids.isEmpty()) {
         // Ensure there are no duplicates in the list
-        const QSet<QMailMessageId> uids(ids.constBegin(), ids.constEnd());
-        QMailMessageIdList idList(uids.constBegin(), uids.constEnd());
+        QMailMessageIdList idList(ids.toSet().toList());
 
         d->notifyMessagesChange(type, idList);
 
@@ -1400,8 +1396,7 @@ void QMailStore::emitRemovalRecordNotification(ChangeType type, const QMailAccou
 {
     if (!ids.isEmpty()) {
         // Ensure there are no duplicates in the list
-        const QSet<QMailAccountId> uids(ids.constBegin(), ids.constEnd());
-        QMailAccountIdList idList(uids.constBegin(), uids.constEnd());
+        QMailAccountIdList idList(ids.toSet().toList());
 
         d->notifyMessageRemovalRecordsChange(type, idList);
 
diff --git a/src/libraries/qmfclient/qmailstorenotifier_p.cpp b/src/libraries/qmfclient/qmailstorenotifier_p.cpp
index 65d0e0d2..71c836b1 100644
--- a/src/libraries/qmfclient/qmailstorenotifier_p.cpp
+++ b/src/libraries/qmfclient/qmailstorenotifier_p.cpp
@@ -202,7 +202,7 @@ void QMailStoreNotifier::notifyAccountsChange(QMailStore::ChangeType changeType,
             flushTimer.start();
         }
 
-        QSet<QMailAccountId> idsSet = QSet<QMailAccountId>(ids.constBegin(), ids.constEnd());
+        QSet<QMailAccountId> idsSet = QSet<QMailAccountId>::fromList(ids);
         switch (changeType)
         {
         case QMailStore::Added:
@@ -237,7 +237,7 @@ void QMailStoreNotifier::notifyMessagesChange(QMailStore::ChangeType changeType,
             flushTimer.start();
         }
 
-        QSet<QMailMessageId> idsSet = QSet<QMailMessageId>(ids.constBegin(), ids.constEnd());
+        QSet<QMailMessageId> idsSet = QSet<QMailMessageId>::fromList(ids);
         switch (changeType)
         {
         case QMailStore::Added:
@@ -311,7 +311,7 @@ void QMailStoreNotifier::notifyMessagesDataChange(const QMailMessageIdList& ids,
             flushTimer.start();
         }
 
-        MessagesProperties props(QPair<QMailMessageKey::Properties, QMailMessageMetaData>(properties, data), QSet<QMailMessageId>(ids.constBegin(), ids.constEnd()));
+        MessagesProperties props(QPair<QMailMessageKey::Properties, QMailMessageMetaData>(properties, data), ids.toSet());
         messagesPropertiesBuffer.append(props);
 
     } else {
@@ -331,7 +331,7 @@ void QMailStoreNotifier::notifyMessagesDataChange(const QMailMessageIdList& ids,
         }
 
         MessagesStatus messageStatus(status, set);
-        messagesStatusBuffer[messageStatus] += QSet<QMailMessageId>(ids.constBegin(), ids.constEnd());
+        messagesStatusBuffer[messageStatus] += ids.toSet();
 
     } else {
         emit ipcAdaptor->messageStatusChanged(ids, status, set);
@@ -349,7 +349,7 @@ void QMailStoreNotifier::notifyThreadsChange(QMailStore::ChangeType changeType,
             flushTimer.start();
         }
 
-        QSet<QMailThreadId> idsSet = QSet<QMailThreadId>(ids.constBegin(), ids.constEnd());
+        QSet<QMailThreadId> idsSet = QSet<QMailThreadId>::fromList(ids);
         switch (changeType)
         {
         case QMailStore::Added:
@@ -385,7 +385,7 @@ void QMailStoreNotifier::notifyFoldersChange(QMailStore::ChangeType changeType,
             flushTimer.start();
         }
 
-        QSet<QMailFolderId> idsSet = QSet<QMailFolderId>(ids.constBegin(), ids.constEnd());
+        QSet<QMailFolderId> idsSet = QSet<QMailFolderId>::fromList(ids);
         switch (changeType)
         {
         case QMailStore::Added:
@@ -420,7 +420,7 @@ void QMailStoreNotifier::notifyMessageRemovalRecordsChange(QMailStore::ChangeTyp
             flushTimer.start();
         }
 
-        QSet<QMailAccountId> idsSet = QSet<QMailAccountId>(ids.constBegin(), ids.constEnd());
+        QSet<QMailAccountId> idsSet = QSet<QMailAccountId>::fromList(ids);
         switch (changeType)
         {
         case QMailStore::Added:
@@ -458,7 +458,7 @@ void QMailStoreNotifier::notifyTransmissionInProgress(const QMailAccountIdList&
 
 bool QMailStoreNotifier::setRetrievalInProgress(const QMailAccountIdList& ids)
 {
-    QSet<QMailAccountId> idSet(ids.constBegin(), ids.constEnd());
+    QSet<QMailAccountId> idSet(ids.toSet());
     if ((idSet != retrievalInProgressIds) || !retrievalSetInitialized) {
         retrievalInProgressIds = idSet;
         retrievalSetInitialized = true;
@@ -470,7 +470,7 @@ bool QMailStoreNotifier::setRetrievalInProgress(const QMailAccountIdList& ids)
 
 bool QMailStoreNotifier::setTransmissionInProgress(const QMailAccountIdList& ids)
 {
-    QSet<QMailAccountId> idSet(ids.constBegin(), ids.constEnd());
+    QSet<QMailAccountId> idSet(ids.toSet());
     if ((idSet != transmissionInProgressIds) || !transmissionSetInitialized) {
         transmissionInProgressIds = idSet;
         transmissionSetInitialized = true;
diff --git a/src/plugins/messageservices/imap/imapservice.cpp b/src/plugins/messageservices/imap/imapservice.cpp
index 32b0a495..2b5cbed1 100644
--- a/src/plugins/messageservices/imap/imapservice.cpp
+++ b/src/plugins/messageservices/imap/imapservice.cpp
@@ -1168,7 +1168,7 @@ bool ImapService::Source::prepareMessages(const QList<QPair<QMailMessagePart::Lo
         bool external(false);
 
         // Are these messages being resolved for internal or external references?
-        QMailMessageKey key(QMailMessageKey::id(referringIds.values()));
+        QMailMessageKey key(QMailMessageKey::id(referringIds.toList()));
         QMailMessageKey::Properties props(QMailMessageKey::Id | QMailMessageKey::ParentAccountId | QMailMessageKey::Status);
 
         for (const QMailMessageMetaData &metaData : QMailStore::instance()->messagesMetaData(key, props)) {
diff --git a/src/plugins/messageservices/imap/imapstrategy.cpp b/src/plugins/messageservices/imap/imapstrategy.cpp
index 4f8b242b..df6302c2 100644
--- a/src/plugins/messageservices/imap/imapstrategy.cpp
+++ b/src/plugins/messageservices/imap/imapstrategy.cpp
@@ -347,15 +347,13 @@ QSet<QMailFolderId> foldersApplicableTo(QMailMessageKey const& messagekey, QSet<
                     if (arg.op == QMailKey::Equal || arg.op == QMailKey::Includes) {
                         Q_ASSERT(arg.valueList.count() == 1);
                         Q_ASSERT(arg.valueList[0].canConvert<QMailFolderId>());
-                        const auto ancestorFolders = QMailStore::instance()->queryFolders(
-                                QMailFolderKey::ancestorFolderIds(arg.valueList[0].value<QMailFolderId>()));
-                        included.unite(QSet<QMailFolderId>(ancestorFolders.constBegin(), ancestorFolders.constEnd()));
+                        included.unite(QMailStore::instance()->queryFolders(
+                                QMailFolderKey::ancestorFolderIds(arg.valueList[0].value<QMailFolderId>())).toSet());
                     } else if (arg.op == QMailKey::NotEqual || arg.op == QMailKey::Excludes) {
                         Q_ASSERT(arg.valueList.count() == 1);
                         Q_ASSERT(arg.valueList[0].canConvert<QMailFolderId>());
-                        const auto ancestorFolders = QMailStore::instance()->queryFolders(
-                                QMailFolderKey::ancestorFolderIds(arg.valueList[0].value<QMailFolderId>()));
-                        excluded.unite(QSet<QMailFolderId>(ancestorFolders.constBegin(), ancestorFolders.constEnd()));
+                        excluded.unite(QMailStore::instance()->queryFolders(
+                                QMailFolderKey::ancestorFolderIds(arg.valueList[0].value<QMailFolderId>())).toSet());
                     } else {
                         Q_ASSERT(false);
                     }
@@ -365,15 +363,13 @@ QSet<QMailFolderId> foldersApplicableTo(QMailMessageKey const& messagekey, QSet<
                     if (arg.op == QMailKey::Equal || arg.op == QMailKey::Includes) {
                         Q_ASSERT(arg.valueList.count() == 1);
                         Q_ASSERT(arg.valueList[0].canConvert<QMailAccountId>());
-                        const auto parentAccountFolders = QMailStore::instance()->queryFolders(
-                                QMailFolderKey::parentAccountId(arg.valueList[0].value<QMailAccountId>()));
-                        included.unite(QSet<QMailFolderId>(parentAccountFolders.constBegin(), parentAccountFolders.constEnd()));
+                        included.unite(QMailStore::instance()->queryFolders(
+                                QMailFolderKey::parentAccountId(arg.valueList[0].value<QMailAccountId>())).toSet());
                     } else if (arg.op == QMailKey::NotEqual || arg.op == QMailKey::Excludes) {
                         Q_ASSERT(arg.valueList.count() == 1);
                         Q_ASSERT(arg.valueList[0].canConvert<QMailAccountId>());
-                        const auto parentAccountFolders = QMailStore::instance()->queryFolders(
-                                QMailFolderKey::parentAccountId(arg.valueList[0].value<QMailAccountId>()));
-                        excluded.unite(QSet<QMailFolderId>(parentAccountFolders.constBegin(), parentAccountFolders.constEnd()));
+                        excluded.unite(QMailStore::instance()->queryFolders(
+                                QMailFolderKey::parentAccountId(arg.valueList[0].value<QMailAccountId>())).toSet());
                     } else {
                         Q_ASSERT(false);
                     }
@@ -1908,9 +1904,9 @@ void ImapSearchMessageStrategy::folderListCompleted(ImapStrategyContextBase *con
         _limit = -1;
         _count = false;
     } else {
-        QSet<QMailFolderId> accountFolders(_mailboxList.constBegin(), _mailboxList.constEnd());
+        QSet<QMailFolderId> accountFolders(_mailboxList.toSet());
 
-        QMailFolderIdList foldersToSearch(foldersApplicableTo(_searches.first().criteria, accountFolders).values());
+        QMailFolderIdList foldersToSearch(foldersApplicableTo(_searches.first().criteria, accountFolders).toList());
 
         if (foldersToSearch.isEmpty()) {
             ImapRetrieveFolderListStrategy::folderListCompleted(context);
diff --git a/src/tools/messageserver/messageserver.cpp b/src/tools/messageserver/messageserver.cpp
index 26dc9ace..57379be6 100644
--- a/src/tools/messageserver/messageserver.cpp
+++ b/src/tools/messageserver/messageserver.cpp
@@ -198,7 +198,7 @@ void MessageServer::retrievalCompleted(quint64 action)
         if (!completionAttempted) {
             // Complete the messages that we selected for immediate completion
             completionAttempted = true;
-            handler->retrieveMessages(action, completionList.values(), QMailRetrievalAction::Content);
+            handler->retrieveMessages(action, completionList.toList(), QMailRetrievalAction::Content);
             return;
         } else {
             completionList.clear();
diff --git a/src/tools/messageserver/servicehandler.cpp b/src/tools/messageserver/servicehandler.cpp
index 5098a24c..9fce8756 100644
--- a/src/tools/messageserver/servicehandler.cpp
+++ b/src/tools/messageserver/servicehandler.cpp
@@ -925,11 +925,6 @@ QSet<QMailMessageService*> ServiceHandler::sourceServiceSet(const QSet<QMailAcco
     return services;
 }
 
-QSet<QMailMessageService*> ServiceHandler::sourceServiceSet(const QMailAccountIdList &ids) const
-{
-    return sourceServiceSet(QSet<QMailAccountId>(ids.constBegin(), ids.constEnd()));
-}
-
 QSet<QMailMessageService*> ServiceHandler::sinkServiceSet(const QMailAccountId &id) const
 {
     QSet<QMailMessageService*> services;
@@ -1191,12 +1186,10 @@ void ServiceHandler::expireAction()
                     }
 
                     if (retrievalSetModified) {
-                        QMailStore::instance()->setRetrievalInProgress(QMailAccountIdList(_retrievalAccountIds.constBegin(),
-                                                                                          _retrievalAccountIds.constEnd()));
+                        QMailStore::instance()->setRetrievalInProgress(_retrievalAccountIds.toList());
                     }
                     if (transmissionSetModified) {
-                        QMailStore::instance()->setTransmissionInProgress(QMailAccountIdList(_transmissionAccountIds.constBegin(),
-                                                                                             _transmissionAccountIds.constEnd()));
+                        QMailStore::instance()->setTransmissionInProgress(_transmissionAccountIds.toList());
                     }
 
                     mActiveActions.erase(it);
@@ -1205,7 +1198,7 @@ void ServiceHandler::expireAction()
                 mActionExpiry.removeFirst();
 
                 // Restart the service(s) for each of these accounts
-                QMailAccountIdList ids(serviceAccounts.constBegin(), serviceAccounts.constEnd());
+                QMailAccountIdList ids(serviceAccounts.toList());
                 deregisterAccountServices(ids, QMailServiceAction::Status::ErrTimeout, tr("Request is not progressing"));
                 registerAccountServices(ids);
 
@@ -1270,12 +1263,10 @@ void ServiceHandler::cancelTransfer(quint64 action)
         }
 
         if (retrievalSetModified) {
-            QMailStore::instance()->setRetrievalInProgress(QMailAccountIdList(_retrievalAccountIds.constBegin(),
-                                                                              _retrievalAccountIds.constEnd()));
+            QMailStore::instance()->setRetrievalInProgress(_retrievalAccountIds.toList());
         }
         if (transmissionSetModified) {
-            QMailStore::instance()->setTransmissionInProgress(QMailAccountIdList(_transmissionAccountIds.constBegin(),
-                                                                                 _transmissionAccountIds.constEnd()));
+            QMailStore::instance()->setTransmissionInProgress(_transmissionAccountIds.toList());
         }
 
         //The ActionData might have already been deleted by actionCompleted, triggered by cancelOperation
@@ -1351,7 +1342,7 @@ void ServiceHandler::transmitMessages(quint64 action, const QMailAccountId &acco
                  QList<QPair<QMailMessagePart::Location,
                              QMailMessagePart::Location> > > unresolvedLists(messageResolvers(unresolvedMessages));
 
-            sources = sourceServiceSet(unresolvedLists.keys());
+            sources = sourceServiceSet(unresolvedLists.keys().toSet());
 
             // Emit no signal after completing preparation
             enqueueRequest(new PrepareMessagesRequest(unresolvedLists), action, sources, &ServiceHandler::dispatchPrepareMessages, 0);
@@ -1400,7 +1391,7 @@ void ServiceHandler::transmitMessage(quint64 action, const QMailMessageId &messa
                  QList<QPair<QMailMessagePart::Location,
                              QMailMessagePart::Location> > > unresolvedLists(messageResolvers(unresolvedMessages));
 
-            sources = sourceServiceSet(unresolvedLists.keys());
+            sources = sourceServiceSet(unresolvedLists.keys().toSet());
 
             // Emit no signal after completing preparation
             enqueueRequest(new PrepareMessagesRequest(unresolvedLists), action, sources, &ServiceHandler::dispatchPrepareMessages, 0);
@@ -1763,7 +1754,7 @@ void ServiceHandler::retrieveMessages(quint64 action, const QMailMessageIdList &
 {
     QMap<QMailAccountId, QMailMessageIdList> messageLists(accountMessages(messageIds));
 
-    QSet<QMailMessageService*> sources(sourceServiceSet(messageLists.keys()));
+    QSet<QMailMessageService*> sources(sourceServiceSet(messageLists.keys().toSet()));
     if (sources.isEmpty()) {
         reportFailure(action, QMailServiceAction::Status::ErrNoConnection,
                       tr("Unable to retrieve messages for unconfigured account"));
@@ -1798,7 +1789,7 @@ bool ServiceHandler::dispatchRetrieveMessages(Request *req)
         }
     }
 
-    QMailStore::instance()->setRetrievalInProgress(QMailAccountIdList(_retrievalAccountIds.constBegin(), _retrievalAccountIds.constEnd()));
+    QMailStore::instance()->setRetrievalInProgress(_retrievalAccountIds.toList());
     return true;
 }
 
@@ -2016,7 +2007,7 @@ void ServiceHandler::onlineDeleteMessages(quint64 action, const QMailMessageIdLi
         discardMessages(action, messageIds);
     } else {
         QMap<QMailAccountId, QMailMessageIdList> messageLists(accountMessages(messageIds));
-        sources = sourceServiceSet(messageLists.keys());
+        sources = sourceServiceSet(messageLists.keys().toSet());
         if (sources.isEmpty()) {
             reportFailure(action, QMailServiceAction::Status::ErrNoConnection, tr("Unable to delete messages for unconfigured account"));
         } else {
@@ -2207,7 +2198,7 @@ void ServiceHandler::onlineMoveMessages(quint64 action, const QMailMessageIdList
     QSet<QMailMessageService*> sources;
 
     QMap<QMailAccountId, QMailMessageIdList> messageLists(accountMessages(messageIds));
-    sources = sourceServiceSet(messageLists.keys());
+    sources = sourceServiceSet(messageLists.keys().toSet());
     if (sources.isEmpty()) {
         reportFailure(action, QMailServiceAction::Status::ErrNoConnection, tr("Unable to move messages for unconfigured account"));
     } else {
@@ -2260,7 +2251,7 @@ void ServiceHandler::onlineFlagMessagesAndMoveToStandardFolder(quint64 action, c
     QSet<QMailMessageService*> sources;
 
     QMap<QMailAccountId, QMailMessageIdList> messageLists(accountMessages(messageIds));
-    sources = sourceServiceSet(messageLists.keys());
+    sources = sourceServiceSet(messageLists.keys().toSet());
     if (sources.isEmpty()) {
         reportFailure(action, QMailServiceAction::Status::ErrNoConnection, tr("Unable to flag messages for unconfigured account"));
     } else {
@@ -2697,7 +2688,7 @@ void ServiceHandler::searchMessages(quint64 action, const QMailMessageKey &filte
 {
     if (spec == QMailSearchAction::Remote) {
         // Find the accounts that we need to search within from the criteria
-        QSet<QMailAccountId> searchAccountIds(accountsApplicableTo(filter, QSet<QMailAccountId>(sourceMap.keyBegin(), sourceMap.keyEnd())));
+        QSet<QMailAccountId> searchAccountIds(accountsApplicableTo(filter, sourceMap.keys().toSet()));
 
         QSet<QMailMessageService*> sources(sourceServiceSet(searchAccountIds));
         if (sources.isEmpty()) {
@@ -3287,7 +3278,7 @@ void ServiceHandler::setRetrievalInProgress(const QMailAccountId &accountId, boo
     }
 
     if (modified) {
-        QMailStore::instance()->setRetrievalInProgress(QMailAccountIdList(_retrievalAccountIds.constBegin(), _retrievalAccountIds.constEnd()));
+        QMailStore::instance()->setRetrievalInProgress(_retrievalAccountIds.toList());
     }
 }
 
@@ -3304,7 +3295,7 @@ void ServiceHandler::setTransmissionInProgress(const QMailAccountId &accountId,
     }
 
     if (modified) {
-        QMailStore::instance()->setTransmissionInProgress(QMailAccountIdList(_transmissionAccountIds.constBegin(), _transmissionAccountIds.constEnd()));
+        QMailStore::instance()->setTransmissionInProgress(_transmissionAccountIds.toList());
     }
 }
 
diff --git a/src/tools/messageserver/servicehandler.h b/src/tools/messageserver/servicehandler.h
index 1569151c..7ce2cef5 100644
--- a/src/tools/messageserver/servicehandler.h
+++ b/src/tools/messageserver/servicehandler.h
@@ -244,7 +244,6 @@ private:
 
     QSet<QMailMessageService*> sourceServiceSet(const QMailAccountId &id) const;
     QSet<QMailMessageService*> sourceServiceSet(const QSet<QMailAccountId> &ids) const;
-    QSet<QMailMessageService*> sourceServiceSet(const QMailAccountIdList &ids) const;
 
     QSet<QMailMessageService*> sinkServiceSet(const QMailAccountId &id) const;
     QSet<QMailMessageService*> sinkServiceSet(const QSet<QMailAccountId> &ids) const;
diff --git a/tests/tst_qmaildisconnected/tst_qmaildisconnected.cpp b/tests/tst_qmaildisconnected/tst_qmaildisconnected.cpp
index 75c9dfc9..4dc4f38d 100644
--- a/tests/tst_qmaildisconnected/tst_qmaildisconnected.cpp
+++ b/tests/tst_qmaildisconnected/tst_qmaildisconnected.cpp
@@ -406,7 +406,7 @@ void tst_QMailDisconnected::test_qmaildisconnected()
     QMailMessage dstMsg;
     QMailDisconnected::copyPreviousFolder(QMailMessage(savedMessage2), &dstMsg);
 
-    QMap<QMailFolderId, QMailMessageIdList> map = QMailDisconnected::restoreMap(allMessages.values());
+    QMap<QMailFolderId, QMailMessageIdList> map = QMailDisconnected::restoreMap(allMessages.toList());
 
     QMailDisconnected::copyToFolder(QMailMessageIdList() << inboxMessage1, archivedId1);
     QMailDisconnected::copyToStandardFolder(QMailMessageIdList() << inboxMessage1, QMailFolder::JunkFolder);
diff --git a/tests/tst_qmailserviceaction/tst_qmailserviceaction.cpp b/tests/tst_qmailserviceaction/tst_qmailserviceaction.cpp
index f604a851..b09b4c43 100644
--- a/tests/tst_qmailserviceaction/tst_qmailserviceaction.cpp
+++ b/tests/tst_qmailserviceaction/tst_qmailserviceaction.cpp
@@ -407,7 +407,7 @@ void tst_QMailServiceAction::test_retrievalaction()
     uint min = 10240u;
     action.retrieveFolderList(accountId1, inboxId1);
     action.retrieveMessageList(accountId2, inboxId2);
-    action.retrieveMessages(allMessages.values());
+    action.retrieveMessages(allMessages.toList());
     action.retrieveMessageRange(inboxMessage1, min);
 
     action.exportUpdates(accountId1);
diff --git a/tests/tst_qmailstorekeys/tst_qmailstorekeys.cpp b/tests/tst_qmailstorekeys/tst_qmailstorekeys.cpp
index 0ab873d1..728ab6b8 100644
--- a/tests/tst_qmailstorekeys/tst_qmailstorekeys.cpp
+++ b/tests/tst_qmailstorekeys/tst_qmailstorekeys.cpp
@@ -98,8 +98,7 @@ private:
     // We only want to compare sets, disregarding ordering
     const QSet<QMailAccountId> accountSet(const QMailAccountKey &key) const
     {
-        const QMailAccountIdList &accounts(QMailStore::instance()->queryAccounts(key));
-        return QSet<QMailAccountId>(accounts.constBegin(), accounts.constEnd());
+        return QMailStore::instance()->queryAccounts(key).toSet();
     }
 
     QSet<QMailAccountId> accountSet() const
@@ -109,8 +108,7 @@ private:
 
     const QSet<QMailFolderId> folderSet(const QMailFolderKey &key) const
     {
-        const QMailFolderIdList &folders(QMailStore::instance()->queryFolders(key));
-        return QSet<QMailFolderId>(folders.constBegin(), folders.constEnd());
+        return QMailStore::instance()->queryFolders(key).toSet();
     }
 
     QSet<QMailFolderId> folderSet() const
@@ -120,8 +118,7 @@ private:
 
     const QSet<QMailMessageId> messageSet(const QMailMessageKey &key) const
     {
-        const QMailMessageIdList &messages(QMailStore::instance()->queryMessages(key));
-        return QSet<QMailMessageId>(messages.constBegin(), messages.constEnd());
+        return QMailStore::instance()->queryMessages(key).toSet();
     }
 
     QSet<QMailMessageId> messageSet() const
@@ -570,9 +567,8 @@ void tst_QMailStoreKeys::accountId()
     QCOMPARE(accountSet(~QMailAccountKey::id(QMailAccountId(), NotEqual)), noAccounts);
 
     // List inclusion
-    const QMailAccountIdList accounts(allAccounts.constBegin(), allAccounts.constEnd());
-    QCOMPARE(accountSet(QMailAccountKey::id(accounts)), allAccounts);
-    QCOMPARE(accountSet(~QMailAccountKey::id(accounts)), noAccounts);
+    QCOMPARE(accountSet(QMailAccountKey::id(allAccounts.toList())), allAccounts);
+    QCOMPARE(accountSet(~QMailAccountKey::id(allAccounts.toList())), noAccounts);
     QCOMPARE(accountSet(QMailAccountKey::id(QMailAccountIdList() << accountId1)), accountSet() << accountId1);
     QCOMPARE(accountSet(~QMailAccountKey::id(QMailAccountIdList() << accountId1)), accountSet() << accountId2 << accountId3 << accountId4);
     QCOMPARE(accountSet(QMailAccountKey::id(QMailAccountIdList() << accountId2)), accountSet() << accountId2);
@@ -581,8 +577,8 @@ void tst_QMailStoreKeys::accountId()
     QCOMPARE(accountSet(~QMailAccountKey::id(QMailAccountIdList() << accountId1 << accountId2)), accountSet() << accountId3 << accountId4);
 
     // List exclusion
-    QCOMPARE(accountSet(QMailAccountKey::id(accounts, Excludes)), noAccounts);
-    QCOMPARE(accountSet(~QMailAccountKey::id(accounts, Excludes)), allAccounts);
+    QCOMPARE(accountSet(QMailAccountKey::id(allAccounts.toList(), Excludes)), noAccounts);
+    QCOMPARE(accountSet(~QMailAccountKey::id(allAccounts.toList(), Excludes)), allAccounts);
     QCOMPARE(accountSet(QMailAccountKey::id(QMailAccountIdList() << accountId1, Excludes)), accountSet() << accountId2 << accountId3 << accountId4);
     QCOMPARE(accountSet(~QMailAccountKey::id(QMailAccountIdList() << accountId1, Excludes)), accountSet() << accountId1);
     QCOMPARE(accountSet(QMailAccountKey::id(QMailAccountIdList() << accountId2, Excludes)), accountSet() << accountId1 << accountId3 << accountId4);
@@ -842,9 +838,8 @@ void tst_QMailStoreKeys::folderId()
     QCOMPARE(folderSet(~QMailFolderKey::id(QMailFolderId(), NotEqual)), noFolders);
 
     // List inclusion
-    const QMailFolderIdList folders(allFolders.constBegin(), allFolders.constEnd());
-    QCOMPARE(folderSet(QMailFolderKey::id(folders)), allFolders);
-    QCOMPARE(folderSet(~QMailFolderKey::id(folders)), standardFolders);
+    QCOMPARE(folderSet(QMailFolderKey::id(allFolders.toList())), allFolders);
+    QCOMPARE(folderSet(~QMailFolderKey::id(allFolders.toList())), standardFolders);
     QCOMPARE(folderSet(QMailFolderKey::id(QMailFolderIdList() << inboxId1)), folderSet() << inboxId1);
     QCOMPARE(folderSet(~QMailFolderKey::id(QMailFolderIdList() << inboxId1)), standardFolders + folderSet() << savedId1 << archivedId1 << inboxId2 << savedId2 << archivedId2);
     QCOMPARE(folderSet(QMailFolderKey::id(QMailFolderIdList() << archivedId2)), folderSet() << archivedId2);
@@ -853,8 +848,8 @@ void tst_QMailStoreKeys::folderId()
     QCOMPARE(folderSet(~QMailFolderKey::id(QMailFolderIdList() << inboxId1 << archivedId2)), standardFolders + folderSet() << savedId1 << archivedId1 << inboxId2 << savedId2);
 
     // List exclusion
-    QCOMPARE(folderSet(QMailFolderKey::id(folders, Excludes)), standardFolders);
-    QCOMPARE(folderSet(~QMailFolderKey::id(folders, Excludes)), allFolders);
+    QCOMPARE(folderSet(QMailFolderKey::id(allFolders.toList(), Excludes)), standardFolders);
+    QCOMPARE(folderSet(~QMailFolderKey::id(allFolders.toList(), Excludes)), allFolders);
     QCOMPARE(folderSet(QMailFolderKey::id(QMailFolderIdList() << inboxId1, Excludes)), standardFolders + folderSet() << savedId1 << archivedId1 << inboxId2 << savedId2 << archivedId2);
     QCOMPARE(folderSet(~QMailFolderKey::id(QMailFolderIdList() << inboxId1, Excludes)), folderSet() << inboxId1);
     QCOMPARE(folderSet(QMailFolderKey::id(QMailFolderIdList() << archivedId2, Excludes)), standardFolders + folderSet() << inboxId1 << savedId1 << archivedId1 << inboxId2 << savedId2);
@@ -1324,9 +1319,8 @@ void tst_QMailStoreKeys::messageId()
     QCOMPARE(messageSet(~QMailMessageKey::id(QMailMessageId(), NotEqual)), noMessages);
 
     // List inclusion
-    const QMailMessageIdList messages(allMessages.constBegin(), allMessages.constEnd());
-    QCOMPARE(messageSet(QMailMessageKey::id(messages)), allMessages);
-    QCOMPARE(messageSet(~QMailMessageKey::id(messages)), noMessages);
+    QCOMPARE(messageSet(QMailMessageKey::id(allMessages.toList())), allMessages);
+    QCOMPARE(messageSet(~QMailMessageKey::id(allMessages.toList())), noMessages);
     QCOMPARE(messageSet(QMailMessageKey::id(QMailMessageIdList() << smsMessage)), messageSet() << smsMessage);
     QCOMPARE(messageSet(~QMailMessageKey::id(QMailMessageIdList() << smsMessage)), allEmailMessages);
     QCOMPARE(messageSet(QMailMessageKey::id(QMailMessageIdList() << inboxMessage1)), messageSet() << inboxMessage1);
@@ -1335,8 +1329,8 @@ void tst_QMailStoreKeys::messageId()
     QCOMPARE(messageSet(~QMailMessageKey::id(QMailMessageIdList() << smsMessage << inboxMessage1)), messageSet() << archivedMessage1 << inboxMessage2 << savedMessage2);
 
     // List Exclusion
-    QCOMPARE(messageSet(QMailMessageKey::id(messages, Excludes)), noMessages);
-    QCOMPARE(messageSet(~QMailMessageKey::id(messages, Excludes)), allMessages);
+    QCOMPARE(messageSet(QMailMessageKey::id(allMessages.toList(), Excludes)), noMessages);
+    QCOMPARE(messageSet(~QMailMessageKey::id(allMessages.toList(), Excludes)), allMessages);
     QCOMPARE(messageSet(QMailMessageKey::id(QMailMessageIdList() << smsMessage, Excludes)), allEmailMessages);
     QCOMPARE(messageSet(~QMailMessageKey::id(QMailMessageIdList() << smsMessage, Excludes)), messageSet() << smsMessage);
     QCOMPARE(messageSet(QMailMessageKey::id(QMailMessageIdList() << inboxMessage1, Excludes)), messageSet() << smsMessage << archivedMessage1 << inboxMessage2 << savedMessage2);
